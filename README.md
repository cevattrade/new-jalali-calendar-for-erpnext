# افزونه تقویم جلالی برای ERPNext

این مخزن یک افزونهٔ کامل برای فعال‌سازی تقویم جلالی (شمسی) در محیط ERPNext/Frappe است. افزونه شامل ابزارهای سمت سرور برای تبدیل تاریخ و همچنین وصلهٔ جاوااسکریپتی برای جایگزینی تقویم پیش‌فرض در رابط کاربری است تا کاربر بتواند به‌صورت بومی با تاریخ‌های جلالی کار کند و در عین حال داده‌ها به شکل میلادی در پایگاه داده ذخیره شود.

> **نکته:** تمام تغییرات به‌صورت افزونهٔ مستقل پیاده‌سازی شده‌اند؛ بنابراین با ارتقای نسخهٔ ERPNext تداخلی ایجاد نمی‌شود و می‌توانید افزونه را در صورت نیاز غیرفعال کنید.

## قابلیت‌ها

- نمایش تاریخ‌ها در فرم‌ها و لیست‌ها به‌صورت جلالی بدون تغییر در دادهٔ ذخیره‌شده.
- تبدیل دوطرفهٔ تاریخ‌ها میان جلالی و میلادی در سمت کاربر و سمت سرور.
- پشتیبانی از اعداد فارسی و عربی در ورودی‌ها.
- ابزارهای تست واحد برای اطمینان از صحت الگوریتم تبدیل.
- راهنمای نصب و عیب‌یابی گام‌به‌گام.

## پیش‌نیازها

- سیستم ERPNext/Frappe نسخهٔ 14 یا بالاتر.
- دسترسی به **bench** و امکان نصب اپلیکیشن‌های سفارشی.
- Python 3.10 یا جدیدتر روی محیط bench.

## نصب سریع

1. وارد پوشهٔ bench خود شوید:
   ```bash
   cd /opt/bench
   ```

2. دریافت (clone) افزونه:
   ```bash
   bench get-app https://github.com/openai/new-jalali-calendar-for-erpnext.git
   ```

3. نصب افزونه روی سایت مدنظر (به جای `site-name` نام سایت خود را قرار دهید):
   ```bash
   bench --site site-name install-app jalali_calendar
   ```

4. ساخت فایل‌های استاتیک و راه‌اندازی خدمات:
   ```bash
   bench build
   bench restart
   ```

5. پس از ورود به ERPNext، کش مرورگر را تازه‌سازی کنید (Ctrl+Shift+R) تا اسکریپت جدید بارگذاری شود.

## تنظیمات پیشنهادی پس از نصب

### ۱. تنظیم قالب نمایش تاریخ
از مسیر **Settings → System Settings → Date and Number Formats** قالب نمایش تاریخ را روی `YYYY-MM-DD` قرار دهید تا با ساختار تقویم جلالی هماهنگ باشد. این کار باعث می‌شود که کنترل‌های تاریخ به درستی مقدار جلالی را نمایش دهند.

### ۲. فعال‌سازی ترجمهٔ فارسی (اختیاری)
اگر قصد دارید محیط کاملاً فارسی باشد، زبان فارسی را فعال کنید:

```bash
bench --site site-name set-config default_language fa
bench --site site-name execute frappe.translate.translate_docstrings --kwargs '{"lang": "fa"}'
```

## نحوهٔ عملکرد

- در سمت کلاینت، فایل `jalali_calendar.bundle.js` کلاس‌های `ControlDate` و `ControlDatetime` را توسعه می‌دهد تا هر ورودی تاریخ را به‌صورت جلالی نمایش دهد و هنگام ارسال فرم، مقدار میلادی به سرور بازگردانده شود.
- در سمت سرور، ماژول `jalali_calendar.api.converter` تبدیل تاریخ‌ها را بدون وابستگی خارجی انجام می‌دهد و می‌توانید آن را در اسکریپت‌ها و گزارش‌های دلخواه استفاده کنید.

### استفاده از توابع تبدیل در سرور

```python
from jalali_calendar.api.converter import gregorian_to_jalali, jalali_to_gregorian

jalali_date = gregorian_to_jalali("2024-03-20")
print(jalali_date.isoformat())  # 1403-01-01

original = jalali_to_gregorian(jalali_date)
print(original)  # datetime.date(2024, 3, 20)
```

## اجرای تست‌ها

برای اطمینان از صحت نصب، می‌توانید تست‌های واحد را روی محیط bench اجرا کنید:

```bash
bench --site site-name run-tests --app jalali_calendar
```

یا در صورت اجرای تست‌ها خارج از bench:

```bash
pytest
```

## عیب‌یابی

| مشکل | راه‌حل |
|------|--------|
| تاریخ‌ها همچنان میلادی نمایش داده می‌شوند | بررسی کنید که دستور `bench build` با موفقیت اجرا شده و کش مرورگر را پاک کرده‌اید. |
| ذخیرهٔ فرم با خطای فرمت تاریخ متوقف می‌شود | مطمئن شوید قالب تاریخ سیستم (`System Settings`) روی `YYYY-MM-DD` تنظیم شده باشد. |
| تاریخ‌های وارد شده با اعداد فارسی ثبت نمی‌شوند | اسکریپت ورودی به‌صورت خودکار اعداد فارسی/عربی را به انگلیسی تبدیل می‌کند. در صورت استفاده از افزونه‌های دیگر که کنترل تاریخ را تغییر می‌دهند، ترتیب بارگذاری دارایی‌ها را بررسی کنید. |

## حذف افزونه

برای حذف افزونه مراحل زیر را انجام دهید:

```bash
bench --site site-name uninstall-app jalali_calendar
bench remove-app jalali_calendar
bench build
bench restart
```

## مجوز

این پروژه تحت مجوز MIT منتشر شده است و می‌توانید آن را برای نیازهای تجاری یا شخصی سفارشی کنید.
